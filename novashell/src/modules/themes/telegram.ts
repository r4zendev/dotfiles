import GLib from "gi://GLib?version=2.0";

import { writeFileAsync } from "ags/file";
import { execAsync } from "ags/process";

import type { ColorData, DerivedPalette } from "./types";
import { adjustLightness, ensureDirectory } from "./utils";

export async function updateTelegramTheme(
	data: ColorData,
	p: DerivedPalette,
): Promise<void> {
	const c = data.colors;
	const s = data.special;

	const theme = `// Generated by novashell

windowBg: ${s.background};
windowFg: ${s.foreground};
windowBgOver: ${p.surface1};
windowBgRipple: ${p.surface1};
windowBoldFg: ${s.foreground};
windowBoldFgOver: ${s.foreground};
windowFgOver: ${s.foreground};
windowSubTextFg: ${p.subtext0};
windowSubTextFgOver: ${p.subtext1};
windowBgActive: ${p.overlay2};
windowFgActive: ${s.foreground};
windowActiveTextFg: ${s.foreground};
windowShadowFg: ${s.background};
windowShadowFgFallback: ${s.background};
shadowFg: ${p.crust}11;
slideFadeOutBg: #0000003c;
slideFadeOutShadowFg: ${c.color0}20;
imageBg: ${s.background};
imageBgTransparent: ${s.background};
activeButtonBg: ${p.accent};
activeButtonBgOver: ${p.accent};
activeButtonBgRipple: ${p.accent};
activeButtonFg: ${p.crust};
activeButtonFgOver: ${p.crust};
activeButtonSecondaryFg: ${p.mantle};
activeButtonSecondaryFgOver: ${p.mantle};
activeLineFg: ${p.overlay2};
activeLineFgError: ${c.color1};
lightButtonBg: ${p.surface0};
lightButtonBgOver: ${p.surface0};
lightButtonBgRipple: ${p.surface1};
lightButtonFg: ${p.accent};
lightButtonFgOver: ${p.accent};
attentionButtonFg: ${s.foreground};
attentionButtonFgOver: ${s.foreground};
attentionButtonBgOver: ${p.surface1}cc;
attentionButtonBgRipple: ${p.surface1};
outlineButtonBg: ${s.background};
outlineButtonBgOver: ${p.surface0};
outlineButtonOutlineFg: ${p.accent};
outlineButtonBgRipple: ${p.surface1};
menuBg: ${s.background};
menuBgOver: ${p.surface0};
menuBgRipple: ${p.surface1};
menuIconFg: ${s.foreground};
menuIconFgOver: ${p.subtext0};
menuSubmenuArrowFg: ${s.foreground};
menuFgDisabled: ${p.subtext0};
menuSeparatorFg: ${p.surface0};
scrollBg: ${p.surface2}cc;
scrollBgOver: ${p.surface2}cc;
scrollBarBg: ${p.overlay1}cc;
scrollBarBgOver: ${p.surface2}cc;
smallCloseIconFg: ${s.foreground};
smallCloseIconFgOver: ${s.foreground};
radialFg: ${s.foreground};
radialBg: ${s.background};
placeholderFg: ${p.subtext0};
placeholderFgActive: ${p.subtext1};
inputBorderFg: ${p.subtext0};
filterInputBorderFg: ${p.accent};
filterInputInactiveBg: ${p.surface0};
checkboxFg: ${p.subtext0};
sliderBgInactive: ${p.surface0};
sliderBgActive: ${p.surface1};
tooltipBg: ${s.background};
tooltipFg: ${s.foreground};
tooltipBorderFg: ${p.surface0};
titleBg: ${s.background};
titleShadow: #00000003;
titleButtonFg: ${s.foreground};
titleButtonBgOver: ${p.surface0};
titleButtonFgOver: ${s.foreground};
titleButtonCloseFg: ${s.foreground};
titleButtonCloseBgOver: ${c.color1};
titleButtonCloseFgOver: ${s.foreground};
titleFg: ${s.foreground};
titleFgActive: ${s.foreground};
trayCounterBg: ${c.color1};
trayCounterBgMute: ${c.color8};
trayCounterFg: ${s.foreground};
trayCounterBgMacInactive: ${c.color8};
trayCounterFgMacInactive: ${s.foreground};
layerBg: #0000007f;
cancelIconFg: ${s.foreground};
cancelIconFgOver: ${s.foreground};
boxBg: ${s.background};
boxTextFg: ${s.foreground};
boxTextFgGood: ${s.foreground};
boxTextFgError: ${c.color1};
boxTitleFg: ${s.foreground};
boxSearchBg: ${s.background};
boxTitleAdditionalFg: ${p.subtext0};
boxTitleCloseFg: ${s.foreground};
boxTitleCloseFgOver: ${s.foreground};
membersAboutLimitFg: ${p.subtext0};
contactsBg: ${s.background};
contactsBgOver: ${p.surface0};
contactsNameFg: ${s.foreground};
contactsStatusFg: ${s.foreground};
contactsStatusFgOver: ${p.overlay0};
contactsStatusFgOnline: ${p.subtext0};
photoCropFadeBg: ${s.background}b0;
photoCropPointFg: ${s.foreground}c0;
introBg: ${s.background};
introTitleFg: ${s.foreground};
introDescriptionFg: ${p.subtext0};
introCoverTopBg: ${s.background};
introCoverBottomBg: ${s.background};
introCoverIconsFg: ${p.subtext0};
introCoverPlaneTrace: ${c.color8}40;
introCoverPlaneInner: ${p.surface1};
introCoverPlaneOuter: ${p.surface0};
introCoverPlaneTop: ${s.foreground};
dialogsBg: ${s.background};
dialogsNameFg: ${s.foreground};
dialogsChatIconFg: ${s.foreground};
dialogsDateFg: ${p.subtext0};
dialogsTextFg: ${p.subtext0};
dialogsTextFgService: ${p.accent};
dialogsDraftFg: ${c.color1};
dialogsVerifiedIconBg: ${p.accent};
dialogsVerifiedIconFg: ${s.background};
dialogsSendingIconFg: ${p.subtext0};
dialogsSentIconFg: ${p.accent};
dialogsUnreadBg: ${p.accent};
dialogsUnreadBgMuted: ${c.color8};
dialogsUnreadFg: ${s.background};
dialogsBgOver: ${p.surface0};
dialogsBgActive: ${p.surface1};
dialogsNameFgActive: ${s.foreground};
dialogsChatIconFgActive: ${s.foreground};
dialogsDateFgActive: ${p.subtext0};
dialogsTextFgActive: ${p.subtext0};
dialogsTextFgServiceActive: ${p.accent};
dialogsDraftFgActive: ${c.color1};
dialogsOnlineBadgeFg: ${c.color2};
dialogsForwardBg: ${p.accent};
dialogsForwardFg: ${s.background};
searchedBarBg: ${p.surface0};
searchedBarFg: ${s.foreground};
topBarBg: ${s.background};
emojiPanBg: ${s.background};
emojiPanCategories: ${s.background};
emojiPanHeaderFg: ${p.subtext0};
emojiPanHeaderBg: ${s.background};
stickerPanDeleteBg: ${c.color8}cc;
stickerPanDeleteFg: ${s.foreground};
stickerPreviewBg: ${s.background}b0;
historyTextInFg: ${s.foreground};
historyTextInFgSelected: ${s.foreground};
historyTextOutFg: ${s.foreground};
historyTextOutFgSelected: ${s.foreground};
historyLinkInFg: ${p.accent};
historyLinkInFgSelected: ${p.accent};
historyLinkOutFg: ${p.accent};
historyLinkOutFgSelected: ${p.accent};
historyFileNameInFg: ${s.foreground};
historyFileNameInFgSelected: ${s.foreground};
historyFileNameOutFg: ${s.foreground};
historyFileNameOutFgSelected: ${s.foreground};
historyOutIconFg: ${p.accent};
historyOutIconFgSelected: ${p.accent};
historyIconFgInverted: ${s.background};
historySendingOutIconFg: ${p.accent};
historySendingInIconFg: ${p.accent};
historySendingInvertedIconFg: ${s.foreground};
historyCallArrowInFg: ${c.color2};
historyCallArrowInFgSelected: ${c.color2};
historyCallArrowMissedInFg: ${c.color1};
historyCallArrowMissedInFgSelected: ${c.color1};
historyCallArrowOutFg: ${c.color2};
historyCallArrowOutFgSelected: ${c.color2};
historyUnreadBarBg: ${p.surface0};
historyUnreadBarBorder: ${p.surface0};
historyUnreadBarFg: ${s.foreground};
historyForwardChooseBg: ${p.accent};
historyForwardChooseFg: ${s.background};
historyPeer1NameFg: ${c.color1};
historyPeer1NameFgSelected: ${c.color1};
historyPeer1UserpicBg: ${c.color1};
historyPeer2NameFg: ${c.color2};
historyPeer2NameFgSelected: ${c.color2};
historyPeer2UserpicBg: ${c.color2};
historyPeer3NameFg: ${c.color3};
historyPeer3NameFgSelected: ${c.color3};
historyPeer3UserpicBg: ${c.color3};
historyPeer4NameFg: ${c.color4};
historyPeer4NameFgSelected: ${c.color4};
historyPeer4UserpicBg: ${c.color4};
historyPeer5NameFg: ${c.color5};
historyPeer5NameFgSelected: ${c.color5};
historyPeer5UserpicBg: ${c.color5};
historyPeer6NameFg: ${c.color6};
historyPeer6NameFgSelected: ${c.color6};
historyPeer6UserpicBg: ${c.color6};
historyPeer7NameFg: ${adjustLightness(c.color4, 30)};
historyPeer7NameFgSelected: ${adjustLightness(c.color4, 30)};
historyPeer7UserpicBg: ${adjustLightness(c.color4, 30)};
historyPeer8NameFg: ${adjustLightness(c.color1, 30)};
historyPeer8NameFgSelected: ${adjustLightness(c.color1, 30)};
historyPeer8UserpicBg: ${adjustLightness(c.color1, 30)};
historyPeerUserpicFg: ${s.background};
historyScrollBarBg: ${p.overlay1}cc;
historyScrollBarBgOver: ${p.surface2}cc;
historyScrollBg: ${p.surface2}cc;
historyScrollBgOver: ${p.surface2}cc;
historyComposeButtonBg: ${p.surface0};
historyComposeButtonBgOver: ${p.surface1};
historyComposeButtonBgRipple: ${p.surface2};
historyComposeIconFg: ${p.subtext0};
historyComposeIconFgOver: ${s.foreground};
historyComposeAreaBg: ${p.surface0};
historyComposeAreaFg: ${s.foreground};
historyComposeAreaFgService: ${p.accent};
historyComposeIconFgInactive: ${c.color8};
historyComposeIconFgActive: ${p.accent};
historySendIconFg: ${p.accent};
historySendIconFgOver: ${p.accent};
historyPinnedBg: ${p.surface0};
historyReplyBg: ${p.surface0};
historyReplyCancelFg: ${s.foreground};
historyReplyCancelFgOver: ${s.foreground};
historyToDownBg: ${s.background};
historyToDownBgOver: ${p.surface0};
historyToDownBgRipple: ${p.surface1};
historyToDownFg: ${p.subtext0};
historyToDownFgOver: ${s.foreground};
historyToDownShadow: #00000040;
msgInBg: ${p.surface0};
msgInBgSelected: ${p.surface1};
msgOutBg: ${adjustLightness(p.accent, -60)};
msgOutBgSelected: ${adjustLightness(p.accent, -45)};
msgSelectOverlay: ${p.accent}40;
msgStickerOverlay: ${p.accent}40;
msgInServiceFg: ${p.accent};
msgInServiceFgSelected: ${p.accent};
msgOutServiceFg: ${p.accent};
msgOutServiceFgSelected: ${p.accent};
msgInShadow: #00000020;
msgInShadowSelected: #00000030;
msgOutShadow: #00000020;
msgOutShadowSelected: #00000030;
msgInDateFg: ${p.subtext0};
msgInDateFgSelected: ${p.subtext0};
msgOutDateFg: ${p.subtext0};
msgOutDateFgSelected: ${p.subtext0};
msgServiceFg: ${s.foreground};
msgServiceBg: ${p.surface0};
msgServiceBgSelected: ${p.surface1};
msgInReplyBarColor: ${p.accent};
msgInReplyBarSelColor: ${p.accent};
msgOutReplyBarColor: ${p.accent};
msgOutReplyBarSelColor: ${p.accent};
msgImgReplyBarColor: ${p.accent};
msgInMonoFg: ${c.color2};
msgOutMonoFg: ${c.color2};
msgInMonoFgSelected: ${c.color2};
msgOutMonoFgSelected: ${c.color2};
msgDateImgFg: ${s.foreground};
msgDateImgBg: ${s.background}b0;
msgDateImgBgOver: ${s.background}c0;
msgDateImgBgSelected: ${s.background}d0;
msgFileThumbLinkInFg: ${p.accent};
msgFileThumbLinkInFgSelected: ${p.accent};
msgFileThumbLinkOutFg: ${p.accent};
msgFileThumbLinkOutFgSelected: ${p.accent};
msgFileInBg: ${p.accent};
msgFileInBgOver: ${p.accent};
msgFileInBgSelected: ${p.accent};
msgFileOutBg: ${p.accent};
msgFileOutBgOver: ${p.accent};
msgFileOutBgSelected: ${p.accent};
msgFile1Bg: ${c.color4};
msgFile1BgDark: ${adjustLightness(c.color4, -30)};
msgFile1BgOver: ${adjustLightness(c.color4, 15)};
msgFile1BgSelected: ${adjustLightness(c.color4, 15)};
msgFile2Bg: ${c.color2};
msgFile2BgDark: ${adjustLightness(c.color2, -30)};
msgFile2BgOver: ${adjustLightness(c.color2, 15)};
msgFile2BgSelected: ${adjustLightness(c.color2, 15)};
msgFile3Bg: ${c.color1};
msgFile3BgDark: ${adjustLightness(c.color1, -30)};
msgFile3BgOver: ${adjustLightness(c.color1, 15)};
msgFile3BgSelected: ${adjustLightness(c.color1, 15)};
msgFile4Bg: ${c.color3};
msgFile4BgDark: ${adjustLightness(c.color3, -30)};
msgFile4BgOver: ${adjustLightness(c.color3, 15)};
msgFile4BgSelected: ${adjustLightness(c.color3, 15)};
msgWaveformInActive: ${p.accent};
msgWaveformInActiveSelected: ${p.accent};
msgWaveformInInactive: ${c.color8};
msgWaveformInInactiveSelected: ${c.color8};
msgWaveformOutActive: ${p.accent};
msgWaveformOutActiveSelected: ${p.accent};
msgWaveformOutInactive: ${c.color8};
msgWaveformOutInactiveSelected: ${c.color8};
msgBotKbOverBgAdd: ${p.surface0}40;
msgBotKbIconFg: ${s.foreground};
msgBotKbRippleBg: ${p.surface0}30;
mediaInFg: ${p.subtext0};
mediaInFgSelected: ${p.subtext0};
mediaOutFg: ${p.subtext0};
mediaOutFgSelected: ${p.subtext0};
youtubePlayIconBg: ${c.color1}e8;
youtubePlayIconFg: ${s.foreground};
videoPlayIconBg: ${s.background}b0;
videoPlayIconFg: ${s.foreground};
toastBg: ${p.crust}cc;
toastFg: ${s.foreground};
reportSpamBg: ${p.surface0};
reportSpamFg: ${c.color1};
historyToDownBadgeBg: ${p.accent};
historyToDownBadgeFg: ${s.background};
profileStatusFg: ${p.subtext0};
profileVerifiedCheckBg: ${p.accent};
profileVerifiedCheckFg: ${s.background};
profileAdminStartFg: ${p.accent};
callArrowFg: ${c.color4};
callArrowMissedFg: ${c.color1};
callAnswerBg: ${c.color2};
callAnswerRipple: ${c.color2};
callAnswerBgOuter: ${c.color2};
callHangupBg: ${c.color1};
callHangupRipple: ${c.color5};
callCancelBg: ${c.color1};
callCancelFg: ${p.crust};
callCancelRipple: ${c.color5};
callMuteRipple: ${c.color1};
callBarBg: ${c.color2};
callBarFg: ${p.crust};
callBarMuteRipple: ${c.color2};
callBarBgMuted: ${c.color1};
callBarUnmuteRipple: ${c.color1};
callBg: ${s.background}cc;
callBgButton: ${p.mantle}cc;
callBgOpaque: ${p.mantle};
callIconFg: ${p.crust};
callIconBg: ${c.color2};
callIconActiveRipple: ${c.color4};
callIconBgActive: ${c.color4};
callIconFgActive: ${p.crust};
callFingerprintBg: ${p.crust}cc;
callNameFg: ${s.foreground};
callStatusFg: ${p.subtext0};
changePhoneSimcardFrom: ${c.color3};
changePhoneSimcardTo: ${c.color3};
botKbBg: ${p.surface0};
botKbDownBg: ${p.surface1};
dialogsChatIconFgOver: ${s.foreground};
dialogsDateFgOver: ${p.subtext0};
dialogsDraftFgOver: ${c.color1};
dialogsMenuIconFg: ${s.foreground};
dialogsMenuIconFgOver: ${s.foreground};
dialogsNameFgOver: ${s.foreground};
dialogsOnlineBadgeFgActive: ${c.color2};
dialogsRippleBg: ${p.surface1};
dialogsRippleBgActive: ${p.surface1};
dialogsSendingIconFgActive: ${p.subtext0};
dialogsSendingIconFgOver: ${p.subtext0};
dialogsSentIconFgActive: ${p.accent};
dialogsSentIconFgOver: ${p.accent};
dialogsTextFgOver: ${p.subtext0};
dialogsTextFgServiceOver: ${p.accent};
dialogsUnreadBgActive: ${p.accent};
dialogsUnreadBgMutedActive: ${c.color8};
dialogsUnreadBgMutedOver: ${c.color8};
dialogsUnreadBgOver: ${p.accent};
dialogsUnreadFgActive: ${s.background};
dialogsUnreadFgOver: ${s.background};
dialogsVerifiedIconBgActive: ${p.accent};
dialogsVerifiedIconBgOver: ${p.accent};
dialogsVerifiedIconFgActive: ${s.background};
dialogsVerifiedIconFgOver: ${s.background};
emojiIconFg: ${p.subtext0};
emojiIconFgActive: ${p.accent};
filterInputActiveBg: ${s.background};
mainMenuBg: ${s.background};
mainMenuCloudBg: ${p.mantle};
mainMenuCloudFg: ${s.foreground};
mainMenuCoverBg: ${p.mantle};
mainMenuCoverFg: ${s.foreground};
mediaPlayerActiveFg: ${p.accent};
mediaPlayerBg: ${s.background};
mediaPlayerDisabledFg: ${p.subtext0};
mediaPlayerInactiveFg: ${c.color8};
mediaviewBg: ${s.background};
mediaviewCaptionBg: ${s.background}cc;
mediaviewCaptionFg: ${s.foreground};
mediaviewControlBg: ${s.background}cc;
mediaviewControlFg: ${s.foreground};
mediaviewFileBg: ${p.surface0};
mediaviewFileBlueCornerFg: ${c.color4};
mediaviewFileExtFg: ${s.foreground};
mediaviewFileGreenCornerFg: ${c.color2};
mediaviewFileNameFg: ${s.foreground};
mediaviewFileRedCornerFg: ${c.color1};
mediaviewFileSizeFg: ${p.subtext0};
mediaviewFileYellowCornerFg: ${c.color3};
mediaviewMenuBg: ${s.background};
mediaviewMenuBgOver: ${p.surface0};
mediaviewMenuBgRipple: ${p.surface1};
mediaviewMenuFg: ${s.foreground};
mediaviewPlaybackActive: ${p.accent};
mediaviewPlaybackActiveOver: ${p.accent};
mediaviewPlaybackIconFg: ${s.foreground};
mediaviewPlaybackIconFgOver: ${s.foreground};
mediaviewPlaybackInactive: ${c.color8};
mediaviewPlaybackInactiveOver: ${c.color8};
mediaviewPlaybackProgressFg: ${s.foreground}20;
mediaviewSaveMsgBg: ${p.mantle}cc;
mediaviewSaveMsgFg: ${s.foreground};
mediaviewTextLinkFg: ${p.accent};
mediaviewTransparentBg: ${s.background};
mediaviewTransparentFg: ${s.foreground};
mediaviewVideoBg: ${s.background};
notificationBg: ${p.mantle};
notificationSampleCloseFg: ${p.subtext0};
notificationSampleNameFg: ${s.foreground};
notificationSampleTextFg: ${p.subtext0};
notificationSampleUserpicFg: ${p.accent};
notificationsBoxMonitorFg: ${s.foreground};
notificationsBoxScreenBg: ${p.surface0};
overviewCheckBg: ${p.accent}40;
overviewCheckBorder: ${p.accent};
overviewCheckFg: ${s.foreground};
overviewCheckFgActive: ${s.background};
overviewPhotoSelectOverlay: ${p.accent}40;
profileStatusFgOver: ${p.subtext0};
sideBarBadgeBg: ${p.accent};
sideBarBadgeBgMuted: ${c.color8};
sideBarBg: ${p.mantle};
sideBarBgActive: ${p.surface0};
sideBarBgRipple: ${p.surface1};
sideBarIconFg: ${p.subtext0};
sideBarIconFgActive: ${p.accent};
sideBarTextFg: ${s.foreground};
sideBarTextFgActive: ${p.accent};
statisticsChartActive: ${p.accent};
statisticsChartInactive: ${c.color8};
titleBgActive: ${s.background};
titleButtonBg: ${s.background}00;
titleButtonBgActive: ${s.background}00;
titleButtonBgActiveOver: ${p.surface0};
titleButtonCloseBg: ${s.background}00;
titleButtonCloseBgActive: ${s.background}00;
titleButtonCloseBgActiveOver: ${c.color1};
titleButtonCloseFgActive: ${s.foreground};
titleButtonCloseFgActiveOver: ${s.foreground};
titleButtonFgActive: ${s.foreground};
titleButtonFgActiveOver: ${s.foreground};
importantTooltipBg: ${p.mantle};
importantTooltipFg: ${s.foreground};
importantTooltipFgLink: ${p.accent};
introErrorFg: ${c.color1};
groupCallBg: ${s.background}cc;
groupCallActiveFg: ${c.color2};
groupCallIconFg: ${s.foreground};
groupCallLeaveBg: ${c.color1};
groupCallLeaveBgRipple: ${adjustLightness(c.color1, -15)};
groupCallMemberActiveIcon: ${c.color2};
groupCallMemberActiveStatus: ${c.color2};
groupCallMemberInactiveIcon: ${p.subtext0};
groupCallMemberInactiveStatus: ${p.subtext0};
groupCallMemberMutedIcon: ${c.color1};
groupCallMemberNotJoinedStatus: ${c.color8};
groupCallMembersBg: ${s.background};
groupCallMembersBgOver: ${p.surface0};
groupCallMembersBgRipple: ${p.surface1};
groupCallMembersFg: ${s.foreground};
groupCallMenuBg: ${p.mantle};
groupCallMenuBgOver: ${p.surface0};
groupCallMenuBgRipple: ${p.surface1};
groupCallMuted1: ${c.color1};
groupCallMuted2: ${adjustLightness(c.color1, -20)};
groupCallVideoSubTextFg: ${p.subtext0};
groupCallVideoTextFg: ${s.foreground};
groupCallLive1: ${c.color2};
groupCallLive2: ${adjustLightness(c.color2, -20)};
groupCallForceMuted1: ${c.color1};
groupCallForceMuted2: ${adjustLightness(c.color1, -15)};
groupCallForceMuted3: ${adjustLightness(c.color1, -30)};
groupCallForceMutedBar1: ${c.color1};
groupCallForceMutedBar2: ${adjustLightness(c.color1, -15)};
groupCallForceMutedBar3: ${adjustLightness(c.color1, -30)};
historyFileInIconFg: ${s.background};
historyFileInIconFgSelected: ${s.background};
historyFileInRadialFg: ${s.background};
historyFileInRadialFgSelected: ${s.background};
historyFileOutIconFg: ${s.background};
historyFileOutIconFgSelected: ${s.background};
historyFileOutRadialFg: ${s.background};
historyFileOutRadialFgSelected: ${s.background};
historyFileThumbIconFg: ${s.foreground};
historyFileThumbIconFgSelected: ${s.foreground};
historyFileThumbRadialFg: ${s.foreground};
historyFileThumbRadialFgSelected: ${s.foreground};
historyPeer1UserpicBg2: ${adjustLightness(c.color1, 20)};
historyPeer2UserpicBg2: ${adjustLightness(c.color2, 20)};
historyPeer3UserpicBg2: ${adjustLightness(c.color3, 20)};
historyPeer4UserpicBg2: ${adjustLightness(c.color4, 20)};
historyPeer5UserpicBg2: ${adjustLightness(c.color5, 20)};
historyPeer6UserpicBg2: ${adjustLightness(c.color6, 20)};
historyPeer7UserpicBg2: ${adjustLightness(c.color4, 50)};
historyPeer8UserpicBg2: ${adjustLightness(c.color1, 50)};
historyPeerSavedMessagesBg: ${p.accent};
historyPeerSavedMessagesBg2: ${adjustLightness(p.accent, 20)};
historyReplyIconFg: ${p.accent};
historyVideoMessageProgressFg: ${p.accent};
`;

	const cacheDir = `${GLib.get_user_cache_dir()}/novashell`;
	ensureDirectory(cacheDir);

	const colorsPath = `${cacheDir}/telegram-colors.tdesktop-theme`;
	await writeFileAsync(colorsPath, theme).catch((e: Error) => {
		console.error(`ColorUtils: Failed to write Telegram colors: ${e.message}`);
	});

	const themePath = `${cacheDir}/telegram-theme.tdesktop-theme`;
	const writePlainTheme = async (): Promise<void> => {
		await writeFileAsync(themePath, theme).catch((e: Error) => {
			console.error(`ColorUtils: Failed to write Telegram theme: ${e.message}`);
		});
	};

	const wallpaper = data.wallpaper;

	if (wallpaper && GLib.file_test(wallpaper, GLib.FileTest.EXISTS)) {
		const resizedPath = `${cacheDir}/telegram-bg.jpg`;
		await execAsync([
			"magick",
			wallpaper,
			"-resize",
			"1920x1920>",
			"-quality",
			"85",
			resizedPath,
		]).catch((e: Error) => {
			console.error(
				`ColorUtils: Failed to resize wallpaper for Telegram: ${e.message}`,
			);
		});

		if (GLib.file_test(resizedPath, GLib.FileTest.EXISTS)) {
			await execAsync([
				"python3",
				"-c",
				`import zipfile,sys\nwith zipfile.ZipFile(sys.argv[1],"w",zipfile.ZIP_DEFLATED) as z:\n z.write(sys.argv[2],"colors.tdesktop-theme")\n z.write(sys.argv[3],"background.jpg")`,
				themePath,
				colorsPath,
				resizedPath,
			]).catch((e: Error) => {
				console.error(
					`ColorUtils: Failed to create Telegram theme ZIP: ${e.message}`,
				);
			});
		} else {
			await writePlainTheme();
		}
	} else {
		await writePlainTheme();
	}
}
