#!/usr/bin/env bash

target="$(tmux display-message -p '#{window_id}')"
original="$(tmux display-message -p '#{window_layout}')"
last="$(tmux show-option -wqv @layout_picker 2>/dev/null)"

labels=(
  "even-horizontal  (M-1)"
  "even-vertical    (M-2)"
  "main-horizontal  (M-3)"
  "main-vertical    (M-4)"
  "tiled            (M-5)"
)

pos=1
for i in "${!labels[@]}"; do
  [[ "${labels[$i]}" == "$last"* ]] && pos=$((i + 1)) && break
done

selected=$(printf '%s\n' "${labels[@]}" | fzf-tmux -p 40%,40% \
  --no-sort --no-preview --no-input --cycle --sync \
  --border-label ' Layout ' --prompt 'âŠž  ' \
  --bind "j:down,k:up" \
  --bind "focus:execute-silent(tmux select-layout -t '$target' \$(echo {} | awk '{print \$1}'))" \
  --bind "start:pos($pos)")

if [ -n "$selected" ]; then
  layout="${selected%%  *}"
  tmux select-layout -t "$target" "$layout"
  tmux set-option -w @layout_picker "$layout"
else
  tmux select-layout -t "$target" "$original"
fi
